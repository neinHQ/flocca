generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String       @id @default(uuid())
  email     String?      @unique
  password  String?      // Hashed
  githubId  String?      @unique
  gitlabId  String?      @unique
  passwordResetTokenHash String?
  passwordResetExpiresAt DateTime?
  createdAt DateTime     @default(now())

  // Billing
  stripeCustomerId   String?
  subscriptionStatus String       @default("free") // "free", "active", "pro", "past_due"
  stripeSubscriptionId String?
  planTier           String       @default("free") // "free", "pro", "team", "enterprise"
  capabilityOverrides Json?       // { allow: string[], deny: string[] }

  connections Connection[]
  teams       TeamMember[]
  billedTeams Team[]       @relation("TeamBillingUser")
}

model Connection {
  id          String   @id @default(uuid())
  provider    String   // e.g. "zephyr", "jira"
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  teamId      String?
  team        Team?    @relation(fields: [teamId], references: [id])
  
  // Encrypted Data
  encryptedData String // JSON string of { token, site_url, ... }
  iv            String // Initialization Vector
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, provider])
}

model Team {
  id          String       @id @default(uuid())
  name        String
  createdAt   DateTime     @default(now())
  billingUserId String?
  seatPlan    String       @default("free") // "free", "teams", "enterprise"
  
  members     TeamMember[]
  connections Connection[] // Shared vault items
  invites     InviteCode[]
  billingUser User?        @relation("TeamBillingUser", fields: [billingUserId], references: [id])
}

model TeamMember {
  id        String   @id @default(uuid())
  userId    String
  teamId    String
  role      String   @default("MEMBER") // OWNER, ADMIN, MEMBER
  assignedSkus Json? @default("[]")
  
  user      User     @relation(fields: [userId], references: [id])
  team      Team     @relation(fields: [teamId], references: [id])

  @@unique([userId, teamId])
}

model InviteCode {
  id        String   @id @default(uuid())
  code      String   @unique
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id])
  expiresAt DateTime
}
